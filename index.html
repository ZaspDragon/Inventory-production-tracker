<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Pallet Tracker â€” Auto OCR + Camera</title>
  <link rel="icon" href="data:,">
  <style>
    :root{--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--brand:#2563eb;--bg:#f6f7fb;--good:#16a34a;--warn:#ea580c;--bad:#dc2626}
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink);margin:0}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.05);padding:16px;margin-bottom:16px}
    h1{font-size:28px;margin:8px 0 16px}
    h2{font-size:18px;margin:0 0 8px}
    label{display:block;font-size:13px;color:#475569;margin:6px 0}
    input,select,button,textarea{font:inherit}
    input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px}
    textarea{min-height:90px;resize:vertical}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-5{grid-column:span 5}
    .col-6{grid-column:span 6}
    .col-7{grid-column:span 7}
    .col-12{grid-column:span 12}
    .btn{background:var(--brand);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.secondary{background:#0f172a0d;color:#0f172a;border:1px solid var(--line)}
    .btn.ghost{background:transparent;color:var(--brand);border:1px dashed var(--brand)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left;vertical-align:top}
    tr:hover{background:#fafafa}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--line)}
    .stat{display:flex;gap:8px;align-items:baseline}
    .stat b{font-size:22px}
    .ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
    .footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
    .small{font-size:12px;color:var(--muted)}
    .flex{display:flex;gap:8px;flex-wrap:wrap}
    .preview{max-width:240px;border:1px solid var(--line);border-radius:12px}
    .progress{height:8px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .progress>div{height:100%;width:0;background:var(--brand);transition:width .3s}
    .camera{width:100%;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#000}
    video{width:100%;height:auto;display:block}
    canvas{display:none}
    .hint{font-size:12px;color:#475569}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#f1f5f9;border:1px solid #e2e8f0;border-bottom-width:3px;border-radius:6px;padding:0 6px}
    .badge{font-size:11px;border:1px solid var(--line);padding:2px 6px;border-radius:999px;background:#fafafa}
    @media (max-width:720px){.col-7,.col-6,.col-5,.col-4,.col-3{grid-column:span 12}}
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
<div class="container">
  <div class="card">
    <h1>ðŸ“¦ Pallet Tracker â€” Auto OCR + Camera</h1>
    <div class="row">
      <div class="col-6">
        <div class="stat"><span class="small">Shift started</span> <b id="shiftStart">â€”</b></div>
        <div class="stat"><span class="small">Elapsed</span> <b id="elapsed">0h</b></div>
      </div>
      <div class="col-6">
        <div class="stat"><span class="small">Pallets moved</span> <b id="totalPallets">0</b></div>
        <div class="stat"><span class="small">Rate/hr</span> <b id="rateHr">0</b></div>
      </div>
    </div>
    <div class="flex" style="margin-top:8px">
      <button id="startShift" class="btn">Start / Restart Shift</button>
      <button id="endShift" class="btn secondary">End Shift (keeps data)</button>
      <button id="exportCsv" class="btn secondary">Export CSV</button>
      <button id="clearAll" class="btn secondary">Clear All</button>
    </div>
    <p class="small">Goal: <b>45 pallets</b> in <b>8 hours</b> (<span id="goalRate">5.625</span> / hr). Goal status: <span id="goalStatus" class="pill">â€”</span></p>
  </div>

  <div class="card">
    <h2>Manual Add</h2>
    <div class="row">
      <div class="col-3">
        <label>Item #</label>
        <input id="item" placeholder="e.g., 601444">
      </div>
      <div class="col-3">
        <label>Qty (pallets)</label>
        <input id="qty" type="number" min="1" value="1">
      </div>
      <div class="col-3">
        <label>From Bin (Aâ€“Z, digits, -)</label>
        <input id="fromBin" placeholder="A-10-4 or ZR-01-7">
      </div>
      <div class="col-3">
        <label>To Bin (Aâ€“Z, digits, -)</label>
        <input id="toBin" placeholder="B-03-2">
      </div>
      <div class="col-12">
        <label>Notes (optional)</label>
        <input id="notes" placeholder="any details...">
      </div>
    </div>
    <div class="flex" style="margin-top:12px">
      <button id="add" class="btn">Add Entry</button>
    </div>
    <p class="hint">Bins now accept <b>Aâ€“Z letters, digits, and dashes</b> anywhere (1â€“32 chars). Example: <code>ZR-01-7</code>, <code>MEZZ-12</code>.</p>
  </div>

  <div class="card">
    <div class="row">
      <div class="col-7">
        <h2>Live Camera Import <span class="badge">auto-import</span></h2>
        <div class="camera"><video id="video" autoplay playsinline></video></div>
        <div class="flex" style="margin-top:8px">
          <button id="snap" class="btn">Capture & Scan</button>
          <button id="toggleCam" class="btn secondary">Switch Camera</button>
        </div>
        <div class="progress" style="margin-top:10px"><div id="ocrProgress"></div></div>
        <p class="hint">Frame the printed/handwritten list so lines are clear. After capture, OCR â†’ parse â†’ <b>auto-imports</b> valid rows.</p>
      </div>
      <div class="col-5">
        <h2>Or Upload Photo</h2>
        <input id="photo" type="file" accept="image/*" capture="environment">
        <img id="preview" class="preview" alt="Preview" style="margin-top:8px">
        <div class="flex" style="margin-top:8px">
          <button id="scanFile" class="btn">Scan File & Auto-Import</button>
        </div>
      </div>
      <div class="col-12">
        <label>OCR Text (editable)</label>
        <textarea id="ocrText" placeholder="Recognized text appears here. You can edit it if needed."></textarea>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Todayâ€™s Moves</h2>
    <table id="logTable">
      <thead><tr>
        <th>Time</th><th>Item #</th><th>Qty</th><th>From</th><th>To</th><th>Notes</th><th></th>
      </tr></thead>
      <tbody></tbody>
    </table>
    <div class="footer">Stored locally on your device (offline ready). Export to CSV to share.</div>
  </div>
</div>

<canvas id="canvas" width="1280" height="720"></canvas>

<script>
// ====== Config & Helpers ======
const GOAL_TOTAL = 45;
const GOAL_HOURS = 8;
const GOAL_RATE = GOAL_TOTAL/GOAL_HOURS;
const BIN_MAX_LEN = 32; // expanded bin length
const $ = id => document.getElementById(id);

function nowISO(){ return new Date().toISOString(); }
function fmtTime(s){ const d=new Date(s); return d.toLocaleString(); }

// Expanded bin clamp/validation:
// - Uppercase
// - Replace whitespace with single dash
// - Only allow Aâ€“Z, digits, and dash
// - Length 1..BIN_MAX_LEN
function clampBin(v){
  v = (v||'').toUpperCase().trim().replace(/\s+/g,'-');
  v = v.replace(/[^A-Z0-9-]+/g,''); // strip illegal chars
  return v.slice(0, BIN_MAX_LEN);
}
function binValid(v){
  return /^[A-Z0-9-]{1,32}$/.test(v);
}

function load(key, fallback){
  try{ return JSON.parse(localStorage.getItem(key)) ?? fallback; }catch(e){ return fallback; }
}
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function todayKey(){ return new Date().toISOString().slice(0,10); }

function getState(){
  const day = todayKey();
  const all = load('palletLogs', {});
  if(!all[day]) all[day] = {shiftStart: null, entries: [], undo: []};
  return {day, all};
}
function setState(all){ save('palletLogs', all); }

function refresh(){
  const {day, all} = getState();
  const st = all[day];
  $('shiftStart').textContent = st.shiftStart ? fmtTime(st.shiftStart) : 'â€”';
  const total = st.entries.reduce((a,e)=> a + (Number(e.qty)||0), 0);
  $('totalPallets').textContent = total;
  let elapsedHrs = 0;
  if(st.shiftStart){
    elapsedHrs = Math.max(0, (Date.now() - new Date(st.shiftStart).getTime())/3600000);
  }
  $('elapsed').textContent = st.shiftStart ? `${elapsedHrs.toFixed(2)}h` : '0h';
  const rate = elapsedHrs>0 ? total/elapsedHrs : 0;
  $('rateHr').textContent = rate.toFixed(2);
  $('goalRate').textContent = GOAL_RATE.toFixed(3);
  const projected = elapsedHrs>0 ? rate*GOAL_HOURS : 0;
  const goalClass = projected>=GOAL_TOTAL ? 'ok' : (projected>=GOAL_TOTAL*0.8?'warn':'bad');
  $('goalStatus').className = `pill ${goalClass}`;
  $('goalStatus').textContent = `Projected ${projected.toFixed(1)} / ${GOAL_TOTAL}`;

  const tbody = document.querySelector('#logTable tbody');
  tbody.innerHTML='';
  st.entries.slice().reverse().forEach((e)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${fmtTime(e.time)}</td>
                    <td>${e.item||''}</td>
                    <td>${e.qty}</td>
                    <td>${e.from}</td>
                    <td>${e.to}</td>
                    <td>${e.notes||''}</td>
                    <td><button data-id="${e.id}" class="btn secondary">Delete</button></td>`;
    tbody.appendChild(tr);
  });
  document.querySelectorAll('td button').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-id');
      const {day, all} = getState();
      const st = all[day];
      const idx = st.entries.findIndex(x=>x.id===id);
      if(idx>-1){
        st.undo.push(st.entries[idx]);
        st.entries.splice(idx,1);
        setState(all);
        refresh();
      }
    };
  });
}

function addEntry(obj){
  const {item='', qty=1, from, to, notes=''} = obj;
  const fromBin = clampBin(from);
  const toBin = clampBin(to);
  if(!binValid(fromBin) || !binValid(toBin)){
    console.warn('Invalid bin(s):', from, to);
    return false;
  }
  const {day, all} = getState();
  all[day].entries.push({id:crypto.randomUUID(), time: nowISO(), item, qty:Math.max(1,Number(qty)||1), from:fromBin, to:toBin, notes});
  setState(all);
  return true;
}
function addMany(list){
  let ok=0, fail=0;
  list.forEach(e=> addEntry(e) ? ok++ : fail++);
  refresh();
  return {ok, fail};
}

// ====== Shift / Manual Add ======
$('startShift').onclick = ()=>{ const {day, all} = getState(); all[day].shiftStart = nowISO(); setState(all); refresh(); };
$('endShift').onclick   = ()=>{ const {day, all} = getState(); all[day].shiftStart = null; setState(all); refresh(); };

$('add').onclick = ()=>{
  const obj = {
    item: $('item').value.trim(),
    qty: $('qty').value,
    from: $('fromBin').value,
    to: $('toBin').value,
    notes: $('notes').value.trim()
  };
  if(addEntry(obj)){
    $('item').value=''; $('qty').value='1'; $('fromBin').value=''; $('toBin').value=''; $('notes').value='';
  }else{
    alert('Bins must be Aâ€“Z letters, numbers, and dashes only (1â€“32 chars).');
  }
};

$('exportCsv').onclick = ()=>{
  const {day, all} = getState();
  const rows = all[day].entries.map(e=>({time:e.time,item:e.item,qty:e.qty,from:e.from,to:e.to,notes:e.notes}));
  const headers = ['time','item','qty','from','to','notes'];
  const csv = [headers.join(','), ...rows.map(r=>headers.map(h=>`"${String(r[h]??'').replaceAll('"','""')}"`).join(','))].join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `pallet_moves_${day}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
};

$('clearAll').onclick = ()=>{
  if(confirm('Clear ALL data for today?')){
    const {day, all} = getState();
    all[day] = {shiftStart:null, entries:[], undo:[]};
    setState(all);
    refresh();
  }
};

// ====== OCR Parsing ======
// Recognize bins generously: find tokens that look like [A-Z0-9-]{2,} and contain at least one letter and one digit (to avoid random words).
function findBins(line){
  const tokens = line.toUpperCase().match(/[A-Z0-9-]{2,}/g) || [];
  const maybeBins = tokens.filter(t => /[A-Z]/.test(t) && /\d/.test(t) && t.length<=BIN_MAX_LEN);
  // Heuristic: collapse consecutive dashes
  return maybeBins.map(t=> clampBin(t.replace(/-+/g,'-')));
}
function findQty(line){
  const m1 = line.match(/(?:qty|q|x|Ã—)\s*[:\-]?\s*(\d{1,3})/i);
  if(m1) return Number(m1[1]);
  const nums = line.match(/\b\d{1,3}\b/g) || [];
  // Prefer 1â€“3 digit numbers that are near "qty" or "x"
  if(nums.length){
    // choose last small number as qty if multiple numbers exist
    return Number(nums[nums.length-1]);
  }
  return 1;
}
function findItem(line){
  // 5â€“12 digit number (not a phone date etc). Prefer the longest.
  const nums = (line.match(/\b\d{5,12}\b/g) || []);
  if(!nums.length) return '';
  nums.sort((a,b)=> b.length - a.length);
  return nums[0];
}

function parseLines(text){
  const out = [];
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  for(const raw of lines){
    const line = raw.replace(/â€”|â€“/g,'-');
    const bins = findBins(line);
    if(bins.length>=2){
      const [from, to] = bins;
      const qty = Math.max(1, findQty(line) || 1);
      const item = findItem(line);
      out.push({item, qty, from, to, notes:''});
      continue;
    }
    // Try arrow or "to"
    const arrow = line.split(/->|â†’| to /i);
    if(arrow.length>=2){
      const from = clampBin(arrow[0].trim());
      const to = clampBin(arrow[1].trim());
      if(binValid(from) && binValid(to)){
        out.push({item: findItem(line), qty: Math.max(1, findQty(line)||1), from, to, notes:''});
      }
    }
  }
  return out;
}

async function runOcrOnImage(imgSrc, onProgress){
  if(!window.Tesseract){ throw new Error('Tesseract.js not loaded'); }
  const worker = await Tesseract.createWorker('eng', 1, {
    logger: m=>{
      if(m.status==='recognizing text' && m.progress!=null){
        onProgress?.(m.progress);
      }
    }
  });
  const { data: { text } } = await worker.recognize(imgSrc);
  await worker.terminate();
  return text;
}

function autoImportFromText(text){
  $('ocrText').value = text;
  const rows = parseLines(text);
  if(!rows.length){ alert('No moves found in OCR text.'); return; }
  const res = addMany(rows);
  alert(`Auto-imported ${res.ok} moves${res.fail?`, ${res.fail} failed`:''}.`);
}

// ====== File Upload OCR (auto-import) ======
const photo = $('photo');
const preview = $('preview');
const progressBar = $('ocrProgress');

photo.addEventListener('change', ()=>{
  const file = photo.files[0];
  if(!file) return;
  const url = URL.createObjectURL(file);
  preview.src = url;
});

$('scanFile').onclick = async ()=>{
  const file = photo.files?.[0];
  if(!file){ alert('Choose an image first.'); return; }
  progressBar.style.width='0';
  try{
    const imgUrl = URL.createObjectURL(file);
    const text = await runOcrOnImage(imgUrl, p=> progressBar.style.width = (p*100).toFixed(0)+'%');
    autoImportFromText(text);
    setTimeout(()=> progressBar.style.width='0', 1200);
  }catch(e){
    console.error(e); alert('OCR failed. Check the image quality and try again.');
  }
};

// ====== Live Camera Capture + OCR (auto-import) ======
const video = $('video');
const canvas = $('canvas');
let currentFacing = 'environment';

async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacing }, audio: false });
    video.srcObject = stream;
  }catch(e){
    console.error(e);
    alert('Camera access denied or not available.');
  }
}
$('toggleCam').onclick = ()=>{
  currentFacing = currentFacing==='environment' ? 'user' : 'environment';
  const stream = video.srcObject;
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
  }
  startCamera();
};

$('snap').onclick = async ()=>{
  if(!video.srcObject){ alert('Starting camera...'); await startCamera(); if(!video.srcObject) return; }
  const w = video.videoWidth || 1280;
  const h = video.videoHeight || 720;
  canvas.width = w; canvas.height = h;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, w, h);
  const dataUrl = canvas.toDataURL('image/png');
  progressBar.style.width='0';
  try{
    const text = await runOcrOnImage(dataUrl, p=> progressBar.style.width = (p*100).toFixed(0)+'%');
    autoImportFromText(text);
    setTimeout(()=> progressBar.style.width='0', 1200);
  }catch(e){
    console.error(e); alert('OCR failed. Try again with a clearer shot.');
  }
};

// Autostart camera if permission previously granted
if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
  startCamera();
}

// Keyboard shortcuts
window.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && (document.activeElement=== $('notes') || document.activeElement=== $('toBin'))){
    e.preventDefault(); $('add').click();
  }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='e'){ e.preventDefault(); $('exportCsv').click(); }
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='z'){
    const {day, all} = getState(); const st=all[day];
    const last = st.undo?.pop(); if(last){ st.entries.push(last); setState(all); refresh(); }
  }
});

// init
refresh();
</script>
</body>
</html>
